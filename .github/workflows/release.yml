name: Build and Release

on:
  push:
    tags:
      - "v*" # Triggers only on version tags (e.g., v1.0.0)

jobs:
  build:
    name: Build & Release
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to create the Release

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: Get Dependencies
        run: |
          go mod tidy

      - name: Build Binaries
        run: |
          # 1. Capture Version from Tag (e.g., v1.0.0)
          VERSION=${GITHUB_REF#refs/tags/}
          echo "Building Version: $VERSION"

          # 2. Set Linker Flags
          # -s -w: Strip debug symbols (smaller binary)
          # -X: Inject version variable into main.go
          LDFLAGS="-s -w -X main.Version=$VERSION"

          # 3. Compile for all targets


          echo "üêß Building Linux AMD64..."
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags "$LDFLAGS" -o lighthouse-linux-amd64 ./cmd/lighthouse

          echo "ü•ß Building Linux ARM64 (Pi)..."
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags "$LDFLAGS" -o lighthouse-linux-arm64 ./cmd/lighthouse

          echo "ü™ü Building Windows..."
          CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -ldflags "$LDFLAGS" -o lighthouse-windows-amd64.exe ./cmd/lighthouse

          echo "üçè Building Darwin (Mac M1/M2)..."
          CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build -ldflags "$LDFLAGS" -o lighthouse-darwin-arm64 ./cmd/lighthouse

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          generate_release_notes: true
          files: |
            lighthouse-linux-amd64
            lighthouse-linux-arm64
            lighthouse-windows-amd64.exe
            lighthouse-darwin-arm64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
